services:
  - type: pserv
    name: chroma
    runtime: image
    image:
      url: docker.io/chromadb/chroma:latest
    plan: standard
    envVars:
      - key: ANONYMIZED_TELEMETRY
        value: FALSE
      - key: IS_PERSISTENT
        value: TRUE
      - key: PERSIST_DIRECTORY
        value: /chromadb
      - fromGroup: veggie-scout-envs

    region: frankfurt
    disk:
      name: data
      mountPath: /chromadb
      sizeGB: 5

  - type: web
    name: api
    runtime: docker
    repo: https://github.com/radu-mutilica/chat-with-repo
    plan: standard
    envVars:
      - key: SIM_SEARCH_TOP_K
        value: 30
      - key: LOG_LEVEL
        value: INFO
      - key: CHROMA_PASSWORD
        sync: false
      - key: CHROMA_USER
        sync: false
      - key: CHROMA_COLLECTION
        value: chat-with-repo
      - key: REDIS_URL
        fromService:
          type: redis
          name: redis
          property: connectionString
      - key: CHROMA_HOST
        fromService:
          name: chroma
          type: pserv
          property: host
      - key: CHROMA_PORT
        fromService:
          name: chroma
          type: pserv
          property: port
      - key: RERANKER_HOST
        fromService:
          name: reranker
          type: pserv
          property: host
      - key: RERANKER_PORT
        fromService:
          name: reranker
          type: pserv
          property: port
      - fromGroup: veggie-scout-envs
    region: frankfurt
    dockerCommand: uvicorn app:app --host 0.0.0.0 --port $PORT
    dockerContext: .
    dockerfilePath: ./api/Dockerfile
    buildFilter:
      ignoredPaths:
        - crawler/**
        - reranker/**
        - evaluation/**
    rootDir: .

  - type: pserv
    name: reranker
    runtime: docker
    repo: https://github.com/radu-mutilica/chat-with-repo
    plan: standard
    envVars:
      - key: LOG_LEVEL
        value: INFO
      - key: CROSSENCODER_TOP_K
        value: 5
      - fromGroup: veggie-scout-envs
    region: frankfurt
    dockerCommand: uvicorn api:app --host 0.0.0.0 --port $PORT
    dockerContext: .
    dockerfilePath: ./reranker/Dockerfile
    buildFilter:
      ignoredPaths:
        - crawler/**
        - api/**
        - evaluation/**
    rootDir: .

  - type: cron
    name: crawler
    runtime: docker
    repo: https://github.com/radu-mutilica/chat-with-repo
    plan: standard
    envVars:
      - key: LOG_LEVEL
        value: INFO
      - key: GITHUB_URL
        value: https://github.com/namoray/vision
      - key: GITHUB_BRANCH
        value: vision-4.0
      - key: CHROMA_COLLECTION
        value: chat-with-repo
      - key: CHROMA_NAME
        value: chromadb
      - key: CHROMA_HOST
        fromService:
          name: chroma
          type: pserv
          property: host
      - key: CHROMA_PORT
        fromService:
          name: chroma
          type: pserv
          property: port
      - fromGroup: veggie-scout-envs

    region: frankfurt
    schedule: '*/60 * * * *'
    dockerCommand: python main.py
    dockerContext: .
    dockerfilePath: ./crawler/Dockerfile
    rootDir: .
    buildFilter:
      ignoredPaths:
        - api/**
        - reranker/**
        - evaluation/**

  - type: pserv
    name: evaluation
    runtime: docker
    repo: https://github.com/radu-mutilica/chat-with-repo
    plan: standard
    envVars:
      - key: LOG_LEVEL
        value: INFO
      - key: CHROMA_COLLECTION
        value: chat-with-repo
      - key: CHROMA_NAME
        value: chromadb
      - key: CHROMA_HOST
        fromService:
          name: chroma
          type: pserv
          property: host
      - key: CHROMA_PORT
        fromService:
          name: chroma
          type: pserv
          property: port
      - fromGroup: veggie-scout-envs

    region: frankfurt
    dockerCommand: ./run_evaluation_pipeline.sh
    dockerContext: .
    dockerfilePath: ./evaluation/Dockerfile
    rootDir: .

  - type: redis
    plan: standard
    name: redis
    region: frankfurt
    ipAllowList: [] # Only allow internal connections

version: "1"